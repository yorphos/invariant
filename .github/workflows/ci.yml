# Continuous Integration - Tests, type checking, and version sync on every push/PR
# This workflow runs quickly to catch issues early without building full installers
#
# COST NOTE: This workflow uses ONLY Linux runners to minimize GitHub Actions costs.
# Private repo pricing: Linux=1x, Windows=2x, macOS=10x (3000 minutes/month free)
# Full multi-platform builds only happen during releases.

name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Check that all version numbers are in sync
  version-check:
    name: Version Sync Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify versions are in sync
        run: |
          # Get version from tauri.conf.json (source of truth for Tauri)
          TAURI_VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
          echo "tauri.conf.json version: $TAURI_VERSION"

          # Get version from package.json
          PKG_VERSION=$(node -p "require('./package.json').version")
          echo "package.json version: $PKG_VERSION"

          # Get version from Cargo.toml
          CARGO_VERSION=$(grep '^version = ' src-tauri/Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Cargo.toml version: $CARGO_VERSION"

          # Check if all versions match
          if [ "$TAURI_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Version mismatch: tauri.conf.json ($TAURI_VERSION) != package.json ($PKG_VERSION)"
            exit 1
          fi

          if [ "$TAURI_VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::Version mismatch: tauri.conf.json ($TAURI_VERSION) != Cargo.toml ($CARGO_VERSION)"
            exit 1
          fi

          echo "All versions are in sync: $TAURI_VERSION"

  # Run tests and type checking (fast feedback)
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Vite build
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            .svelte-kit
          key: vite-${{ runner.os }}-${{ hashFiles('src/**', 'vite.config.ts', 'svelte.config.js', 'tsconfig.json') }}
          restore-keys: |
            vite-${{ runner.os }}-

      - name: Run TypeScript check
        run: npm run check

      - name: Run tests
        run: npm run test:run

      - name: Build frontend
        run: npm run build

  # Verify Tauri builds work (Linux only for cost efficiency)
  # Multi-platform builds are done during releases only
  build-check:
    name: Build Check (Linux)
    needs: [version-check, test]
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Install frontend dependencies
        run: npm ci

      - name: Cache Vite build
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            .svelte-kit
          key: vite-${{ runner.os }}-${{ hashFiles('src/**', 'vite.config.ts', 'svelte.config.js', 'tsconfig.json') }}
          restore-keys: |
            vite-${{ runner.os }}-

      # Build in debug mode (faster) just to verify compilation works
      - name: Verify Tauri build
        run: |
          npm run build
          cargo build --manifest-path src-tauri/Cargo.toml
